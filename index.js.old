require('dotenv').config();
const express = require('express');
const oracledb = require('oracledb');
const axios = require('axios');

const app = express();
const port = process.env.PORT || 3000;

app.use(express.urlencoded({ extended: true }));
app.use(express.json());

app.post('/postcode', async (req, res) => {
  const { text: postcode, response_url, user_name } = req.body;

  // Stuur direct een snelle reactie terug aan Slack
  res.status(200).json({
    response_type: 'ephemeral',
    text: `:mag: Even kijken naar postcode *${postcode}*...`
  });

  let connection;
  try {
    connection = await oracledb.getConnection({
      user: process.env.DB_USER,
      password: process.env.DB_PASSWORD,
      connectString: process.env.DB_CONNECTSTRING
    });

    const query = `
      SELECT STRAATNAAM, PLAATSNAAM
      FROM KTB_PCDATA
      WHERE WIJKCODE || LETTERCOMBINATIE = :postcode
      FETCH FIRST 1 ROWS ONLY
    `;
    const result = await connection.execute(query, [postcode], { outFormat: oracledb.OUT_FORMAT_OBJECT });

    if (result.rows.length === 0) {
      await axios.post(response_url, {
        response_type: 'ephemeral',
        text: `:warning: Geen adres gevonden voor *${postcode}*, ${user_name}.`
      });
    } else {
      const { STRAATNAAM, PLAATSNAAM } = result.rows[0];

      await axios.post(response_url, {
        response_type: 'in_channel',
        blocks: [
          {
            type: 'section',
            text: {
              type: 'mrkdwn',
              text: `:mailbox_with_mail: Resultaat voor postcode *${postcode}*:`
            }
          },
          {
            type: 'section',
            text: {
              type: 'mrkdwn',
              text: `*Straat:* ${STRAATNAAM}\n*Plaats:* ${PLAATSNAAM}`
            }
          },
          {
            type: 'context',
            elements: [
              {
                type: 'mrkdwn',
                text: `Zoekopdracht uitgevoerd door <@${user_name}>`
              }
            ]
          }
        ]
      });
    }

  } catch (err) {
    console.error('âŒ Fout:', err);
    await axios.post(response_url, {
      response_type: 'ephemeral',
      text: `:x: Er ging iets mis bij het zoeken naar postcode *${postcode}*.`
    });
  } finally {
    if (connection) {
      try {
        await connection.close();
      } catch (err) {
        console.error('Fout bij sluiten van connectie', err);
      }
    }
  }
});

app.listen(port, () => {
  console.log(`Server draait op http://localhost:${port}`);
});

